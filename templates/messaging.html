<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>WebWork Messaging</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@100;200;300;400;500;600;700;800;900&display=swap" rel="stylesheet">
    <script src="https://cdn.socket.io/4.5.4/socket.io.min.js"></script>
    <style>
        @keyframes bounce {
            0%, 60%, 100% { transform: translateY(0); }
            30% { transform: translateY(-5px); }
        }
        .typing-indicator .dot {
            animation: bounce 1.5s infinite ease-in-out;
        }
        .typing-indicator .dot:nth-child(2) {
            animation-delay: 0.2s;
        }
        .typing-indicator .dot:nth-child(3) {
            animation-delay: 0.4s;
        }
        .message-status {
            font-size: 0.75rem;
            color: #6b7280;
            margin-left: 0.5rem;
        }
        .message-status.read {
            color: #3b82f6;
        }
    </style>
</head>
<body class="bg-[#001721] font-['Poppins'] text-white">
    <!-- Navigation -->
    <header class="bg-[#0f0e2c] text-white flex justify-between items-center p-4 px-8 shadow-md">
        <div class="text-2xl font-bold">WebWork</div>
        
        <!-- Search Bar -->
        <div class="relative w-1/3">
            <input 
                type="text" 
                id="userSearch" 
                placeholder="Search users..." 
                class="w-full py-1 px-4 pr-10 rounded-full text-gray-800 focus:outline-none focus:ring-2 focus:ring-blue-500"
            >
            <div class="absolute right-3 top-1/2 transform -translate-y-1/2">
                <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5 text-gray-500" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M21 21l-6-6m2-5a7 7 0 11-14 0 7 7 0 0114 0z" />
                </svg>
            </div>
            <!-- Search Results Dropdown -->
            <div id="searchResults" class="absolute z-50 w-full mt-1 bg-white rounded-md shadow-lg hidden max-h-60 overflow-y-auto">
                <!-- Results will be populated here -->
            </div>
        </div>
        
        <nav class="space-x-6 text-sm">
            <a href="#" class="hover:underline">About</a>
            <a href="#" class="hover:underline">Contact</a>
            <a href="{{ url_for('login') }}" class="hover:underline">Login</a>
            <a href="{{ url_for('register') }}" class="hover:underline">Log-out</a>
            <a href="{{ url_for('dashboard') }}" class="hover:underline">Profile</a>
        </nav>
    </header>

    <!-- Main Content -->
    <section class="flex h-[calc(100vh-5rem)]">
        <div class="flex w-full">
            <!-- Sidebar -->
            <aside class="w-20 bg-[#001721] flex flex-col items-center py-5 border-t border-r border-opacity-10 border-white">
                <img src="" alt="profile" id="profile-picture" class="w-12 h-12 rounded-full mb-5">
            
                <div class="flex flex-col items-center">
                    <a href="{{ url_for('messagereq') }}"mb-4"><img src="/static/message.png" alt="Messages" class="w-10 h-10"></a>
                    <a href="{{ url_for('trashbin') }}"" class="mb-4"><img src="/static/trash can.png" alt="Trash" class="w-10 h-10"></a>
                </div>
                <div class="mt-auto pt-5 border-t border-opacity-10 border-white">
                    <a href="settings.html" class="flex justify-center items-center w-10 h-10">  
                        <img src="/static/settings.png" alt="Settings" class="w-10 h-10">
                    </a>
                </div>
            </aside>

            <!-- Main Content Area -->
            <div class="flex flex-1">
                <!-- Contacts Section -->
                <div class="w-72 flex flex-col border-r border-opacity-10 border-white">
                    <div class="p-5">
                        <input type="text" id="contact-search" placeholder="Search contacts" class="w-full px-3 py-2 rounded-full bg-[#202c34] text-white border-none focus:outline-none">
                    </div>
                    <div id="contacts-list" class="flex-1 overflow-y-auto p-2 space-y-2">
                        <!-- Contacts will be loaded here -->
                    </div>
                    <div class="p-4 flex justify-center">
                        <button onclick="showAddContactModal()" class="w-10 h-10 bg-[#202c34] text-white text-2xl rounded-full flex items-center justify-center hover:bg-[#2c3e50] transition-colors">
                            +
                        </button>
                    </div>
                </div>

                <!-- Chat Area -->
                <div class="flex-1 flex flex-col bg-[#001721]">
                    <!-- Contact Info Header -->
                    <div class="flex items-center p-4 bg-[#202c34] rounded-t-lg">
                        <div id="typing-indicator" class="typing-indicator overflow-hidden flex items-center ml-2">
                            <div class="dot w-2 h-2 bg-gray-400 rounded-full mr-1"></div>
                            <div class="dot w-2 h-2 bg-gray-400 rounded-full mr-1"></div>
                            <div class="dot w-2 h-2 bg-gray-400 rounded-full"></div>
                            <span class="text-xs ml-2">typing...</span>
                        </div>
                        <h2 id="contact-name" class="text-lg font-semibold mr-2"></h2>
                        <div class="ml-auto">
                        </div>
                    </div>

                    <!-- Messages Container -->
                    <div id="message-container" class="flex-1 overflow-y-auto p-4 space-y-3" data-current-contact="">
                        <!-- Messages will be inserted here by JavaScript -->
                    </div>

                    <!-- Message Input -->
                    <div class="p-4 bg-[#202c34] rounded-b-lg flex items-center gap-2">
                        <input type="file" id="file-input" class="hidden">
                        <button onclick="document.getElementById('file-input').click()" class="p-2 rounded-full hover:bg-gray-600 transition-colors">
                            <img src="/static/attach-file.png" alt="Attach" class="w-5 h-5">
                        </button>
                        <input type="text" id="message-input" placeholder="Type your message here" 
                               class="flex-1 px-4 py-2 bg-[#202c34] text-white rounded-full border border-gray-600 focus:outline-none"
                               oninput="handleTyping()">
                        <button id="send-button" onclick="sendMessage()" class="px-6 py-2 bg-[#d9561d] text-white rounded-full hover:bg-[#393f41] transition-colors">
                            Send
                        </button>
                    </div>
                </div>
            </div>
        </div>
    </section>

    <!-- Add Contact Modal -->
    <div id="add-contact-modal" class="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center overflow-hidden z-50">
        <div class="bg-[#202c34] text-white rounded-lg shadow-lg p-6 w-[400px] max-h-[600px] overflow-y-auto">
            <div class="flex justify-between items-center mb-4">
                <h2 class="text-lg font-semibold">Add a Contact</h2>
                <button onclick="closeAddContactModal()" class="text-gray-400 hover:text-white">
                    &times;
                </button>
            </div>
            <div class="mb-4">
                <input type="text" id="user-search" placeholder="Search users..." 
                       class="w-full px-3 py-2 rounded bg-[#001721] text-white border-none focus:outline-none">
            </div>
            <ul id="user-list" class="space-y-2">
                <!-- Users will be loaded here -->
            </ul>
        </div>
    </div>

    <script>
        // Global variables
        let socket;
        let currentContactId = null;
        let currentContactName = '';
        let currentContactPicture = '';
        let typingTimeout;
        let currentUser = {
            id: '' // This should be set from your authentication system
        };

        // Initialize when DOM is loaded
        document.addEventListener('DOMContentLoaded', function() {
            // Initialize Socket.IO connection
            socket = io();
            
            // Set up socket error handlers
            socket.on('connect_error', (error) => {
                console.error('Socket connection error:', error);
                alert('Connection error. Please refresh the page.');
            });

            socket.on('disconnect', (reason) => {
                console.log('Socket disconnected:', reason);
                if (reason === 'io server disconnect') {
                    alert('Server disconnected. Please login again.');
                }
            });
            
            // Load user profile
            loadUserProfile();
            
            // Load contacts
            loadContacts();
            
            // Set up event listeners
            setupEventListeners();
            
            // Set up Socket.IO event handlers
            setupSocketHandlers();
        });

        function loadUserProfile() {
            fetch('/get_user_profile')
                .then(response => {
                    if (!response.ok) throw new Error('Failed to load user profile');
                    return response.json();
                })
                .then(data => {
                    if (data.profile_picture) {
                        document.getElementById('profile-picture').src = data.profile_picture;
                    }
                    // Set current user ID if available
                    if (data.user_id) {
                        currentUser.id = String(data.user_id);
                    }
                })
                .catch(error => {
                    console.error('Error loading user profile:', error);
                });
        }



    document.addEventListener("DOMContentLoaded", () => {
        fetch("/get_user_profile")
            .then(response => response.json())
            .then(data => {
            if (data.profile_picture) {
                const profileImg = document.getElementById("profile-picture");
                profileImg.src = data.profile_picture;
            }
            })
            .catch(error => {
            console.error("Error fetching user profile picture:", error);
            });
        });

    function loadContacts() {
        console.log('[Contacts] Loading contacts...');
        const contactsList = document.getElementById('contacts-list');
        contactsList.innerHTML = '<div class="p-4 text-center text-gray-400">Loading contacts...</div>';

        fetch('/get_contacts')
            .then(response => {
                if (!response.ok) {
                    throw new Error(`HTTP error! status: ${response.status}`);
                }
                return response.json();
            })
            .then(data => {
                console.log('[Contacts] Received data:', data);
                contactsList.innerHTML = '';

                if (!data.contacts || data.contacts.length === 0) {
                    contactsList.innerHTML = '<p class="text-center text-gray-400 p-4">No contacts yet. Add some!</p>';
                    return;
                }

                const sortedContacts = data.contacts.sort((a, b) => {
                    if (a.is_pinned !== b.is_pinned) return b.is_pinned - a.is_pinned;
                    return new Date(b.updated_at) - new Date(a.updated_at);
                });

                sortedContacts.forEach(contact => {
                    const contactElement = document.createElement('div');
                    contactElement.className = `contact-item flex items-center p-3 hover:bg-[#202c34] rounded-lg cursor-pointer ${contact.unread_count > 0 ? 'bg-[#202c34]' : ''}`;
                    contactElement.dataset.contactId = contact.user_id;

                    contactElement.innerHTML = `
                       <div class="chat-profile relative">
                        <img src="${contact.profile_picture || '/static/default-profile.png'}" 
                            alt="${contact.name}" class="w-10 h-10 rounded-full">
                        ${contact.status === 'online' ? 
                            '<span class="absolute bottom-0 right-0 w-3 h-3 bg-green-500 rounded-full border-2 border-gray-800"></span>' : ''}
                    </div>

                    <div class="message-stack flex-1 ml-3 overflow-hidden">
                        <div class="name-profile flex justify-between items-center">
                            <h3 class="font-medium truncate">${contact.name}</h3>

                            <div class="flex items-center gap-2">
                                <span class="text-xs text-gray-400 whitespace-nowrap">
                                    ${formatTime(contact.updated_at)}
                                </span>

                           <div class="contact-item" data-contact-id="${contact.user_id}">
                                <button class="delete-button w-7 h-7 bg-white rounded-full flex items-center justify-center hover:bg-gray-300 transition-colors" data-id="${contact.user_id}">
                                    <img src="/static/trash can.png" alt="delete contact" class="w-4 h-4">
                                </button>
                                </div>

                                <button onclick="togglePin(this, '${contact.user_id}', ${contact.is_pinned})"
                                        data-pinned="${contact.is_pinned}"
                                        class="w-7 h-7 bg-[#202c34] ${contact.is_pinned ? 'text-yellow-400' : 'text-white'} text-lg rounded-full flex items-center justify-center hover:bg-[#2c3e50] transition-colors">
                                    ★
                                </button>
                            </div>
                        </div>

                        <div class="flex justify-between items-center">
                            <div class="text-sm text-gray-400 truncate">
                                ${contact.last_message}
                            </div>

                            ${contact.unread_count > 0 ? 
                                `<span class="ml-2 bg-green-500 text-white text-xs rounded-full h-5 w-5 flex items-center justify-center">
                                    ${contact.unread_count}
                                </span>` : ''}
                        </div>
                    </div>
                    <div class="status-ind                       
                        `;

                        contactElement.addEventListener('click', () => {
                            console.log(`Opening conversation with ${contact.user_id}`);
                            openConversation(contact.user_id, contact.name, contact.profile_picture);
                        });

                        contactElement.querySelector('.delete-button').addEventListener('click', (e) => {
                            e.stopPropagation();
                            console.log(`Deleting contact ${contact.user_id}`);
                            deleteContact(contact.user_id);
                        });

                        contactsList.appendChild(contactElement);
                    });
                })
                .catch(error => {
                    console.error('[Contacts] Error loading contacts:', error);
                    contactsList.innerHTML = `
                        <div class="text-center p-4">
                            <p class="text-red-400">Error loading contacts</p>
                            <button onclick="loadContacts()" class="mt-2 px-4 py-2 bg-blue-500 text-white rounded hover:bg-blue-600">
                                Retry
                            </button>
                        </div>
                `;
        });
}



        function openConversation(contactId, contactName, contactPicture) {
            currentContactId = contactId;
            currentContactName = contactName;
            currentContactPicture = contactPicture;
            
            // Update UI
            document.getElementById('contact-name').textContent = contactName;
            document.getElementById('message-container').dataset.currentContact = contactId;
            document.getElementById('typing-indicator').classList.add('hidden');
            
            // Clear and show loading state
            const container = document.getElementById('message-container');
            container.innerHTML = '<div class="text-center py-8 text-gray-400">Loading messages...</div>';
            
            // Load messages with proper sender/recipient filtering
            fetch(`/get_conversation/${contactId}`)
                .then(response => {
                    if (!response.ok) throw new Error('Network response was not ok');
                    return response.json();
                })
                .then(data => {
                    // Store current user ID from server response
                    if (data.current_user_id) {
                        currentUser.id = String(data.current_user_id);
                    }
                    
                    container.innerHTML = '';
                    
                    if (data.messages && data.messages.length > 0) {
                        data.messages.forEach(message => {
                            appendMessage(message, data.current_user_id);
                        });
                        
                        // Scroll to bottom
                        container.scrollTop = container.scrollHeight;
                        // Mark messages as read
                        markMessagesAsRead(contactId);
                    } else {
                        container.innerHTML = `
                            <div class="flex flex-col items-center justify-center h-full text-gray-400">
                                <img src="${contactPicture || '/static/default-profile.png'}" 
                                    alt="${contactName}" class="w-20 h-20 rounded-full mb-4">
                                <p class="text-lg">No messages yet</p>
                                <p class="text-sm">Start your conversation with ${contactName}</p>
                            </div>
                        `;
                    }
                })
                .catch(error => {
                    console.error('Error loading messages:', error);
                    container.innerHTML = `
                        <div class="text-center py-8 text-red-400">
                            Error loading messages. Please try again.<br>
                            <button onclick="openConversation('${contactId}', '${contactName}', '${contactPicture}')" 
                                    class="mt-2 px-4 py-2 bg-[#d9561d] rounded">
                                Retry
                            </button>
                        </div>
                    `;
                });
            
            // Join conversation room
            socket.emit('join_conversation', { contact_id: contactId });
        }
        function togglePin(button, contactId, currentPinned) {
            const newPinnedStatus = !currentPinned;

            fetch('/pin_contact', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json'
                },
                body: JSON.stringify({
                    contact_id: contactId,
                    is_pinned: newPinnedStatus
                })
            })
            .then(res => res.json())
            .then(data => {
                if (data.success) {
                    // Re-fetch and re-render the contact list to reflect sorting
                    loadContacts(); // Make sure this function already exists to fetch and render contacts
                } else {
                    console.error(data.message);
                }
            })
            .catch(err => console.error('Error:', err));
}

        function appendMessage(message, currentUserId) {
            const container = document.getElementById('message-container');
            
            // Use the is_current_user flag from backend if available
            // Fall back to frontend comparison if not
            const isCurrentUser = message.is_current_user !== undefined 
                ? message.is_current_user
                : String(message.sender) === String(currentUserId || currentUser.id);
            
            // Skip temporary messages that might have been persisted
            if (message.id && message.id.startsWith('temp-') && message.persisted) {
                const existingMsg = container.querySelector(`[data-message-id="${message.id}"]`);
                if (existingMsg) {
                    existingMsg.remove();
                }
            }
            
            const messageElement = document.createElement('div');
            messageElement.className = `flex ${isCurrentUser ? 'justify-end' : 'justify-start'} mb-3`;
            messageElement.dataset.messageId = message.id;
            messageElement.dataset.sender = message.sender; // Store sender in dataset
            
            messageElement.innerHTML = `
                <div class="flex max-w-[80%] ${isCurrentUser ? 'flex-row-reverse' : ''}">
                    ${!isCurrentUser ? `
                        <img src="${currentContactPicture || '/static/default-profile.png'}" 
                            alt="${currentContactName}" 
                            class="w-8 h-8 rounded-full mr-2 mt-1">
                    ` : ''}
                    <div class="${isCurrentUser ? 'bg-[#d9561d]' : 'bg-[#202c34]'} rounded-lg p-3">
                        <p class="text-white">${message.content}</p>
                        <div class="flex justify-end items-center mt-1 space-x-1">
                            <span class="text-xs text-gray-300">
                                ${formatTime(message.timestamp)}
                            </span>
                            ${isCurrentUser ? `
                                <span class="message-status ${message.status === 'read' ? 'read' : ''}">
                                    ${message.status === 'read' ? '✓✓' : '✓'}
                                </span>
                            ` : ''}
                        </div>
                    </div>
                </div>
            `;
            
            container.appendChild(messageElement);
            container.scrollTop = container.scrollHeight;
        }

        // function appendMessage(message) {
        //     const container = document.getElementById('message-container');
        //     const isCurrentUser = String(message.sender) === String(currentUser.id);
        //     // Skip temporary messages that might have been persisted
        //     if (message.id && message.id.startsWith('temp-') && message.persisted) {
        //         const existingMsg = container.querySelector(`[data-message-id="${message.id}"]`);
        //         if (existingMsg) {
        //             existingMsg.remove();
        //         }
        //     }
            
        //     const messageElement = document.createElement('div');
        //     messageElement.className = `flex ${isCurrentUser ? 'justify-end' : 'justify-start'} mb-3`;
        //     messageElement.dataset.messageId = message.id;
            
        //     messageElement.innerHTML = `
        //         <div class="flex max-w-[80%] ${isCurrentUser ? 'flex-row-reverse' : ''}">
        //             ${!isCurrentUser ? `
        //                 <img src="${currentContactPicture || '/static/default-profile.png'}" 
        //                     alt="${currentContactName}" 
        //                     class="w-8 h-8 rounded-full mr-2 mt-1">
        //             ` : ''}
        //             <div class="${isCurrentUser ? 'bg-[#d9561d]' : 'bg-[#202c34]'} rounded-lg p-3">
        //                 <p class="text-white">${message.content}</p>
        //                 <div class="flex justify-end items-center mt-1 space-x-1">
        //                     <span class="text-xs text-gray-300">
        //                         ${formatTime(message.timestamp)}
        //                     </span>
        //                     ${isCurrentUser ? `
        //                         <span class="message-status ${message.status === 'read' ? 'read' : ''}">
        //                             ${message.status === 'read' ? '✓✓' : '✓'}
        //                         </span>
        //                     ` : ''}
        //                 </div>
        //             </div>
        //         </div>
        //     `;
            
        //     container.appendChild(messageElement);
        //     container.scrollTop = container.scrollHeight;
        // }

        function setupEventListeners() {
            // Contact search
            document.getElementById('contact-search').addEventListener('input', function() {
                const searchTerm = this.value.toLowerCase();
                const contacts = document.querySelectorAll('.contact-item');
                
                contacts.forEach(contact => {
                    const name = contact.querySelector('h3').textContent.toLowerCase();
                    if (name.includes(searchTerm)) {
                        contact.style.display = 'flex';
                    } else {
                        contact.style.display = 'none';
                    }
                });
            });
            
            // User search in add contact modal
            document.getElementById('user-search').addEventListener('input', function() {
                const searchTerm = this.value.trim();
                if (searchTerm.length >= 2) {
                    searchUsers(searchTerm);
                }
            });
            
            // Send message on Enter key
            document.getElementById('message-input').addEventListener('keypress', function(e) {
                if (e.key === 'Enter') {
                    sendMessage();
                }
            });
        }

        function setupSocketHandlers() {
            // Handle new messages
            socket.on('new_message', function(data) {
                if (data.sender === currentContactId || data.sender === currentUser.id) {
                    appendMessage(data);
                    
                    // Mark as read if it's the current conversation
                    if (data.sender === currentContactId) {
                        markMessageAsRead(data.id);
                    }
                }
                
                // Update contacts list to show new message
                updateContactLastMessage(data.sender === currentUser.id ? data.recipient : data.sender, data.content);
            });
            
            // Handle message sent confirmation
            socket.on('message_sent', function(data) {
                updateMessageStatus(data.id, 'delivered');
            });
            
            // Handle message read notification
            socket.on('message_read', function(data) {
                updateMessageStatus(data.message_id, 'read');
            });
            
            // Handle typing indicator with additional checks
            socket.on('user_typing', function(data) {
                if (data.sender === currentContactId) {
                    const typingIndicator = document.getElementById('typing-indicator');
                    
                    // Clear any existing timeout
                    if (window.typingTimeout) {
                        clearTimeout(window.typingTimeout);
                    }
                    
                    if (data.is_typing) {
                        typingIndicator.classList.remove('hidden');
                        // Set timeout to hide indicator if no follow-up comes
                        window.typingTimeout = setTimeout(() => {
                            typingIndicator.classList.add('hidden');
                        }, 5000); // 5 seconds
                    } else {
                        typingIndicator.classList.add('hidden');
                    }
                }
            });

                // Handle disconnection to clear typing indicators
            socket.on('disconnect', function() {
                const typingIndicator = document.getElementById('typing-indicator');
                typingIndicator.classList.add('hidden');
            });
            
            // Handle status updates (online/offline)
            socket.on('status', function(data) {
                updateUserStatus(data.user_id, data.status);
            });
        }

        function sendMessage() {
            const input = document.getElementById('message-input');
            const message = input.value.trim();
            
            if (message && currentContactId) {
                const tempMessageId = 'temp-' + Date.now();
                const tempMessage = {
                    id: tempMessageId,
                    sender: currentUser.id,
                    content: message,
                    timestamp: new Date().toISOString(),
                    status: 'sending',
                    is_current_user: true  // Explicit flag
                };
                
                appendMessage(tempMessage);
                input.value = '';
                
                fetch('/send_message', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify({
                        recipient: currentContactId,
                        message: message,
                        temp_message_id: tempMessageId
                    })
                })
                .then(response => response.json())
                .then(data => {
                    if (data.status === 'success') {
                        const tempMsgElement = document.querySelector(`[data-message-id="${tempMessageId}"]`);
                        if (tempMsgElement) {
                            tempMsgElement.dataset.messageId = data.message_id;
                            tempMsgElement.dataset.sender = data.sender; // Update sender in dataset
                            const statusElement = tempMsgElement.querySelector('.message-status');
                            if (statusElement) {
                                statusElement.textContent = '✓';
                            }
                        }
                        
                        socket.emit('new_message', {
                            id: data.message_id,
                            sender: data.sender,
                            recipient: data.recipient,
                            content: message,
                            timestamp: new Date().toISOString(),
                            status: 'sent',
                            is_current_user: true,
                            temp_message_id: tempMessageId
                        });
                    }
                })
                .catch(error => {
                    console.error('Error sending message:', error);
                    updateMessageStatus(tempMessageId, 'failed');
                });
                
                socket.emit('typing', {
                    recipient: currentContactId,
                    is_typing: false
                });
            }
        }
        // After sending a message, verify it was persisted
        function verifyMessagePersisted(tempId, realId) {
            fetch(`/check_message_health/${realId}`)
                .then(response => response.json())
                .then(data => {
                    if (data.exists) {
                        const tempMsg = document.querySelector(`[data-message-id="${tempId}"]`);
                        if (tempMsg) {
                            tempMsg.dataset.messageId = realId;
                            const statusElement = tempMsg.querySelector('.message-status');
                            if (statusElement) {
                                statusElement.textContent = '✓✓';
                                statusElement.classList.add('read');
                            }
                        }
                    } else {
                        updateMessageStatus(tempId, 'failed');
                    }
                });
        }

        function handleTyping() {
            if (!currentContactId) return;
            
            // Clear previous timeout
            clearTimeout(typingTimeout);
            
            // Emit typing event
            socket.emit('typing', {
                recipient: currentContactId,
                is_typing: true
            });
            
            // Set timeout to stop typing indicator after 2 seconds of inactivity
            typingTimeout = setTimeout(() => {
                socket.emit('typing', {
                    recipient: currentContactId,
                    is_typing: false
                });
            }, 2000);
        }

        function markMessagesAsRead(contactId) {
            fetch('/mark_messages_read', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                },
                body: JSON.stringify({
                    contact_id: contactId
                })
            })
            .catch(error => {
                console.error('Error marking messages as read:', error);
            });
        }

        function markMessageAsRead(messageId) {
            socket.emit('mark_read', {
                message_id: messageId
            });
        }

        function updateMessageStatus(messageId, status) {
            const messageElement = document.querySelector(`[data-message-id="${messageId}"]`);
            if (messageElement) {
                const statusElement = messageElement.querySelector('.message-status');
                if (statusElement) {
                    if (status === 'failed') {
                        statusElement.textContent = '!';
                        statusElement.classList.add('failed');
                        statusElement.title = 'Failed to send';
                    } else {
                        statusElement.textContent = status === 'read' ? '✓✓' : '✓';
                        statusElement.classList.toggle('read', status === 'read');
                    }
                }
                
                // For temporary messages that were persisted
                if (status === 'delivered' && messageId.startsWith('temp-')) {
                    const contentElement = messageElement.querySelector('.text-white');
                    if (contentElement) {
                        messageElement.dataset.messageId = messageId.replace('temp-', '');
                    }
                }
            }
        }

        // function updateContactLastMessage(contactId, message) {
        //     const contactElement = document.querySelector(`.contact-item[data-contact-id="${contactId}"]`);
        //     if (contactElement) {
        //         const lastMessageElement = contactElement.querySelector('.text-sm');
        //         if (lastMessageElement) {
        //             lastMessageElement.textContent = message;
        //         }
                
        //         // Update timestamp
        //         const timeElement = contactElement.querySelector('.text-xs');
        //         if (timeElement) {
        //             timeElement.textContent = formatTime(new Date().toISOString());
        //         }
        //     }
        // }

        function updateUserStatus(userId, status) {
            const contactElement = document.querySelector(`.contact-item[data-contact-id="${userId}"]`);
            if (contactElement) {
                const statusIndicator = contactElement.querySelector('.status-indicator');
                if (!statusIndicator) {
                    const nameElement = contactElement.querySelector('h3');
                    if (nameElement) {
                        const indicator = document.createElement('span');
                        indicator.className = `status-indicator ml-2 w-2 h-2 rounded-full ${status === 'online' ? 'bg-green-500' : 'bg-gray-500'}`;
                        nameElement.appendChild(indicator);
                    }
                } else {
                    statusIndicator.className = `status-indicator ml-2 w-2 h-2 rounded-full ${status === 'online' ? 'bg-green-500' : 'bg-gray-500'}`;
                }
            }
        }

        function showAddContactModal() {
            document.getElementById('add-contact-modal').classList.remove('hidden');
            document.getElementById('user-search').focus();
        }

        function closeAddContactModal() {
            document.getElementById('add-contact-modal').classList.add('hidden');
            document.getElementById('user-search').value = '';
            document.getElementById('user-list').innerHTML = '';
        }

        function searchUsers(query) {
            fetch(`/search-users?q=${encodeURIComponent(query)}`)
                .then(response => {
                    if (!response.ok) throw new Error('Search failed');
                    return response.json();
                })
                .then(data => {
                    const userList = document.getElementById('user-list');
                    userList.innerHTML = '';
                    
                    if (data.length > 0) {
                        data.forEach(user => {
                            const userElement = document.createElement('li');
                            userElement.className = 'flex items-center p-2 hover:bg-[#001721] rounded cursor-pointer';
                            userElement.innerHTML = `
                                <img src="${user.profile_picture || '/static/default-profile.png'}" 
                                    alt="${user.full_name}" class="w-10 h-10 rounded-full mr-3">
                                <div class="flex-1">
                                    <div class="font-medium">${user.full_name}</div>
                                    <div class="text-sm text-gray-400">@${user.username}</div>
                                </div>
                                <button onclick="addUserAsContact('${user._id}', event)" 
                                        class="ml-auto bg-[#d9561d] text-white px-3 py-1 rounded text-sm">
                                    Add
                                </button>
                            `;
                            userList.appendChild(userElement);
                        });
                    } else {
                        userList.innerHTML = '<li class="text-center text-gray-400 p-2">No users found</li>';
                    }
                })
                .catch(error => {
                    console.error('Error searching users:', error);
                    const userList = document.getElementById('user-list');
                    userList.innerHTML = '<li class="text-center text-red-400 p-2">Error searching users</li>';
                });
        }

        function addUserAsContact(userId, event) {
            event.stopPropagation();

            fetch('/add_contact', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                },
                body: JSON.stringify({
                    user_id: userId
                })
            })
            .then(response => {
                if (!response.ok) throw new Error('Failed to add contact');
                return response.json();
            })
            .then(data => {
                if (data.success) {
                    // Remove "no contacts" message if exists
                    const contactsList = document.getElementById('contacts-list');
                    const noContactsMsg = contactsList.querySelector('p');
                    if (noContactsMsg) noContactsMsg.remove();

                    // Create the contact element with the same structure as loadContacts
                    const contactElement = document.createElement('div');
                    contactElement.className = `contact-item flex items-center p-3 hover:bg-[#202c34] rounded-lg cursor-pointer ${data.contact.unread_count > 0 ? 'bg-[#202c34]' : ''}`;
                    contactElement.dataset.contactId = data.contact.user_id;

                    contactElement.innerHTML = `
                        <div class="chat-profile relative">
                            <img src="${data.contact.profile_picture || '/static/default-profile.png'}" 
                                alt="${data.contact.name}" class="w-10 h-10 rounded-full">
                            ${data.contact.status === 'online' ? 
                                '<span class="absolute bottom-0 right-0 w-3 h-3 bg-green-500 rounded-full border-2 border-gray-800"></span>' : ''}
                        </div>

                        <div class="message-stack flex-1 ml-3 overflow-hidden">
                            <div class="name-profile flex justify-between items-center">
                                <h3 class="font-medium truncate">${data.contact.name}</h3>
                                <div class="flex items-center gap-2">
                                    <span class="text-xs text-gray-400 whitespace-nowrap">
                                        ${formatTime(data.contact.updated_at)}
                                    </span>

                                    <button class="delete-button w-7 h-7 bg-white rounded-full flex items-center justify-center hover:bg-gray-300 transition-colors" data-id="${data.contact.user_id}">
                                        <img src="/static/trash can.png" alt="delete contact" class="w-4 h-4">
                                    </button>

                                    <button onclick="togglePin(this, '${data.contact.user_id}', ${data.contact.is_pinned})"
                                            data-pinned="${data.contact.is_pinned}"
                                            class="w-7 h-7 bg-[#202c34] ${data.contact.is_pinned ? 'text-yellow-400' : 'text-white'} text-lg rounded-full flex items-center justify-center hover:bg-[#2c3e50] transition-colors">
                                        ★
                                    </button>
                                </div>
                            </div>

                            <div class="flex justify-between items-center">
                                <div class="text-sm text-gray-400 truncate">
                                    ${data.contact.last_message}
                                </div>

                                ${data.contact.unread_count > 0 ? 
                                    `<span class="ml-2 bg-green-500 text-white text-xs rounded-full h-5 w-5 flex items-center justify-center">
                                        ${data.contact.unread_count}
                                    </span>` : ''}
                            </div>
                        </div>
                    `;

                    // Add event handlers
                    contactElement.addEventListener('click', () => {
                        openConversation(data.contact.user_id, data.contact.name, data.contact.profile_picture);
                    });

                    contactElement.querySelector('.delete-button').addEventListener('click', (e) => {
                        e.stopPropagation();
                        deleteContact(data.contact.user_id);
                    });

                    // Add to contacts list (prepend to the top)
                    contactsList.prepend(contactElement);

                    // Close the modal
                    closeAddContactModal();
                } else {
                    alert(data.message || 'Failed to add contact');
                }
            })
            .catch(error => {
                alert(error.message || 'An error occurred');
            });
        }
                    document.addEventListener('click', function (e) {
                if (e.target.closest('.delete-button')) {
                    const button = e.target.closest('.delete-button');
                    const contactId = button.getAttribute('data-id');
                    console.log(`Deleting contact with ID: ${contactId}`);  // Log the contactId
                    deleteContact(contactId);
                }
            });

            function deleteContact(contactId) {
                if (confirm('Are you sure you want to delete this contact?')) {
                    fetch('/delete_contact', {
                        method: 'POST',
                        headers: {
                            'Content-Type': 'application/json',
                        },
                        body: JSON.stringify({
                            contact_id: contactId
                        })
                    })
                    .then(response => {
                        if (!response.ok) throw new Error('Failed to delete contact');
                        return response.json();
                    })
                    .then(data => {
                        if (data.success) {
                            // Remove contact from the UI immediately after successful deletion
                            const contactElement = document.querySelector(`.contact-item[data-contact-id="${contactId}"]`);
                            if (contactElement) {
                                contactElement.remove();
                            }
                        } else {
                            alert(data.message || 'Failed to delete contact');
                        }
                    })
                    .catch(error => {
                        alert(error.message || 'An error occurred while deleting contact');
                    });
                }
            }

            
        function formatTime(timestamp) {
            const date = new Date(timestamp);
            return date.toLocaleTimeString([], { hour: '2-digit', minute: '2-digit' });
        }
    </script>
</body>
</html>